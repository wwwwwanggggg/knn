# 挑战网技术部后端二考文档  
技术部后端的二考时间预计为`2023/12/07 00:00(UTC+8) 至 2023/12/18  06:00 (UTC+8)`   
期间引领人大部分时间将会神隐,但至少保证每交完一稿后会有回复,如果引领人没有回复可以寻找其他引领人并举报下自己的引领人)   
**每次交完一稿后都要及时联系引领人**

同样的,大群将会禁言至考核全部结束,所以有问题需要及时联系引领人   

如若API文档出现错误或不易理解的部分,请及时联系引领人,引领人在确定是API文档的问题后会及时在大群里更新API文档或进行修改,所以请不要屏蔽大群错过关键信息😡😡😡   

# 考核标准

1. 完整实现提供的API文档

2. 数据库结构设计合理

3. 系统鲁棒性要求  

4. 部分较难需求已标注加分点,可选做  

# 考核范围

1. 熟练掌握tz-gin的项目结构和使用方式

2. 熟练掌握sql语句和mysql相关操作以及gorm等orm的操作


# 考核要求

- 通过提供的API文档(抢票系统)实现一个完整后端,数据库表需自行设计      
  > (加分点) 后端会涉及到高并发场景,与部分sql事务需求,需要自行模拟并处理情况  
- 敏感数据做加密处理,例如密码等,引领人会查看源码,保证数据的安全性 (加密算法不限)  
- 可以使用联表查询的地方要使用联表查询
- URL、request要求和文档要求保持一致,response可以不同但内容必须完整
- POST和PUT方法可以有请求体,GET和DELETE方法没有请求体
- 本次二考所使用的数据库一律命名为`tenzor2023` ,密码为`123456`。不一致者打回
- 二考使用git提交,在`git.tiaozhan.tech`上新建一个仓库`finaltenzor`并设置为私密,并将你的引路人拉入git仓库 
- 如果遇到问题,请学会查看 go 自身的报错信息并尝试解决问题。二考过程中引领人可以回答有关知识,但是不会直接说出答案。  
- 很多方面的问题都可以查看官网来解决  
- 将Postman或ApiFox的请求和响应保存为json文件,并提交到仓库中(参考对应的文档)  
- 将数据库的表结构另存为sql文件,放在tz-gin的sql文件夹下  
 
# 抢票系统(演出票)基本功能

1. 作为用户：

   - 进行注册,最开始用户并没有账号,需要自行注册(用户名加密码)
   - 在没有抢到某一种类型的票时,可以选择当前有余票的任一场次进行抢票
   - 抢到票后,不可以再对同一种类型的票进行抢票(一般指同一明星的不同场次,不同明星搭台属于不同场次)
   - 查看某个场次演出的具体信息
   - 查看演出的简略展示(列表形式),类似购物时,搜索完某商品后,出现很多商品,仅包含部分信息,点击后展示更详细的信息
   - 查看自己已经抢到的所有票
   - 放弃自己所抢到的票
2. 作为管理员：

   - 添加演出具体的演出(要求包含开始时间,结束时间,地点,最大人数,参演明星,演出内容,宣传语...其余内容自由发挥)
   - 修改某个具体演出场次的信息(修改演出时间,地点,演出名,最大人数等)
   - 删除某个场次的演出
   - 查看所有的演出场次(同一种类型的演出展示在一起,比如a演出,分别在周一早上8点主a进行,还在周二早上8点主b进行,两条信息相邻展示)
   - 查看某场次演出的具体被选择情况
   - 在某一场次演出期间,其场地不能被申请作为另一场次演出的场地,明星同理

  **注意,既然是抢票,那就涉及多个人在同一时间抢最后一张票,如何处理好这种情况需要注意**

# API详情

## 响应

所有的响应均为`Response200`

#### 当请求成功时,返回以下内容

```json
{
  "success": true,
  "data":{} // data可以为空
}
```

#### 当请求失败时,返回以下内容

```json
{
  "success": false,
  "code": 2, // code_type
  "message":"报错信息"
}
```
        

## 用户模块：

### 用户注册 `POST /api/user`

+ Request

  ```json
   {
     "username": "tenzor",
     "password": "ilovetenzor"
   }
   ```

+ Response

   ```json
   {
     "success": true
   }
   ```

注册后需要将用户信息存入数据库中  

#### Extra  
需要预留一个注册接口,通过gitea进行注册,并获取相关个人信息  
~~如果实在觉得这部分比较困难,可以留到至少交完完整的一版后再做~~

<details>
<summary>具体操作</summary> 

- 用户登录预留一个接入gitea的统一认证登录的接口,[gitea的API文档](https://git.tiaozhan.tech/api/swagger#/)    
下面是一般的Oauth2.0流程  
![pic](./2023考核用登录流程.png)    
有关Oauth2可以参考[这篇文章](https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html)  
~~同时可以设计一个简单的统一登录认证系统,并将API文档所实现的应用接入该统一认证 (当作思考题)~~  

</details> 




### 登录 `POST /api/login`

+ Request

  ```json
   {
     "username": "tenzor",
     "password": "ilovetenzor"
   }
   ```

+ Response

   ```json
   {
     "success": true
   }
   ```

#### Extra


通过gitea进行登录,并获取相关信息  
接入gitea的oauth2认证,相关资料参考gitea的官方文档  
~~和登录接口一样,如果实在觉得这部分比较困难,可以留到至少交完完整的一版后再做~~

<a id="user-logout"><a>

### 登出 `DELETE /api/logout`

+ Request

      // 无需参数

+ Response

   ```json
   {
     "success": true
   }
   ```

### 获取当前登录信息 `GET /api/getinfo`

+ Request

      // 无需参数

+ Response


    ```json
    {
      "success": true,
      "data": {
        "userName":"tenzor",
        ...
      }
    }
    ```

### 获取演出列表`GET /api/user/shows`

- Request

  |    query参数    |  类型  |              示例               |
  |-----------------|--------|---------------------------------|
  |      page       | number |                1                |
  |      size       | number |                2                |
  | content(非必须) | string | 想要查询的内容(演出名,明星名等) |

- Request(示例)

  ```json
  {
    "success": true,
    "data": {
      "total": 10,
      "shows":[
          {
              "showId":1,
              "title":"xxx演出1", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-01T18:00:00",
              "endTime": "2023-01-01T22:00:00",
              "location": "主A4-3",
          },
          {
              "showId":2,
              "title":"xxx演出1", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-05T18:00:00",
              "endTime": "2023-01-06T22:00:00",
              "location": "主A4-3",
          },
          {
              "showId":3,
              "title":"xxx演出2", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-02T18:00:00",
              "endTime": "2023-01-02T22:00:00",
              "location": "主A4-3",
          },
          {
              "showId":2,
              "title":"xxx演出2", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-03T18:00:00",
              "endTime": "2023-01-03T22:00:00",
              "location": "主A4-3",
          }
      ]
    }
  }
  ```

  



### 抢票`POST /api/user/grab-ticket`

- Request：
  ```json
  {
    "showId":1
  }
  ```
- Response：
  ```json
  {
    "success": true,
    "data": {
      "ticketId":1,
      "showId":1
    }
  }
  ```

### 查看演出详情：`GET /api/user/show/:id`


- Request

  | query参数 |  类型  | 示例 |
  |-----------|--------|------|
  |  showId   | number |  1   |

- Response：
  ```json
  {
    "success": true,
    "data": {
        "showId":1,
        "title":"xxx演出", // 可以有多场内容完全一直的演出,就是时间场地不一致
        "startTime": "2023-01-01T18:00:00",
        "endTime": "2023-01-01T22:00:00",
        "location": "主A4-3",
        "maxCapacity": 50, // 总票数
        "currCapacity": 40, // 剩余票数
        "performers": [
                {
                    starId:1,
                    name:"明星B"
                },
                {
                    starId:2,
                    name:"明星B"
                }
            ],
        "showContent": "",
        "promo": "立即购票！",
        "purchased":true/false(自己是否购买)
    }
  }
  ```

### 查看已抢到的票`GET/api/user/tickets`

- Request

  |    query参数    |  类型  |      示例      |
  |-----------------|--------|----------------|
  |      page       | number |       1        |
  |      size       | number |       2        |
  | content(非必须) | string | 想要查询的内容 |

- Reponse：
  ```json
  {
    "success": true,
    "data": {
      "total": 10,
      "shows":[
          {
              "showId":1,
              "title":"xxx演出1", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-01T18:00:00",
              "endTime": "2023-01-01T22:00:00",
              "location": "主A4-3",
          },
          {
              "showId":5,
              "title":"xxx演出2", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-05T18:00:00",
              "endTime": "2023-01-06T22:00:00",
              "location": "主A4-3",
          }
      ]
    }
  }
  ```

### **放弃已抢到的票`DELETE /api/user/abandon-ticket`：**

- Request

  | query参数 |  类型  | 示例 |
  |-----------|--------|------|
  |  showId   | number |  1   |

- Response：
  ```json
  {
    "success": true,
    "data": {
      "message": "票已成功放弃。"
    }
  }
  ```

## 管理员模块：

### **添加演出`POST /api/admin/show`：**

- Request：

  ```json
  {
        "title":"xxx演出", // 可以有多场内容完全一直的演出,就是时间场地不一致
        "startTime": "2023-01-01T18:00:00",
        "endTime": "2023-01-01T22:00:00",
        "location": "主A4-3",
        "maxCapacity": 50, // 总票数
        "performers": [1,2,3], // 明星id
        "showContent": "演出内容",
        "promo": "立即购票！(宣传语)"
  }
  ```
- 响应：
  ```json
  {
    "success": true,
    "data": {
      "showId": 1
    }
  }
  ```

### **修改演出详情`PUT /api/admin/show/:id`**

- 请求：(除showId外,其余参数非必需,选择填取)
  ```json
  {
      "title":"xxx演出", // 可以有多场内容完全一直的演出,就是时间场地不一致
      "startTime": "2023-01-01T18:00:00",
      "endTime": "2023-01-01T22:00:00",
      "location": "主A4-3",
      "maxCapacity": 50, // 总票数
      "performers": [1,2],
      "showContent": "演出内容",
      "promo": "立即购票！(宣传语)"
  }
  ```
- 响应：
  ```json
  {
    "success": true,
    "data": {
      "message": "演出详情已成功更新。"
    }
  }
  ```

### **查看演出详情`GET /api/admin/show/:id`：**

- Request



- 响应：

  ```json
  {
    "success": true,
    "data": {
        "showId":1,
        "title":"xxx演出", // 可以有多场内容完全一直的演出,就是时间场地不一致
        "startTime": "2023-01-01T18:00:00",
        "endTime": "2023-01-01T22:00:00",
        "location": "主A4-3",
        "maxCapacity": 50, // 总票数
        "currCapacity": 40, // 剩余票数
        "performers": [
            {
                starId:1,
                name:"明星B"
            },
            {
                starId:2,
                name:"明星B"
            }
        ],  
        "showContent": "",
        "promo": "立即购票！",
        "purchased":true/false(自己是否购买)
    }
  }
  ```

### **删除演出`DELETE /api/admin/show/:id`**

- Request


- Response：
  ```json
  {
    "success": true,
    "data": {
      "message": "演出已成功删除。"
    }
  }
  ```

### 获取演出列表`GET /api/admin/shows`

- Request

  |    query参数    |  类型  |              示例               |
  |-----------------|--------|---------------------------------|
  |      page       | number |                1                |
  |      size       | number |                2                |
  | content(非必须) | string | 想要查询的内容(演出名,明星名等) |

- Response(示例)

  ```json
  {
    "success": true,
    "data": {
      "total": 10,
      "shows":[
          {
              "showId":1,
              "title":"xxx演出1", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-01T18:00:00",
              "endTime": "2023-01-01T22:00:00",
              "location": "主A4-3",
          },
          {
              "showId":2,
              "title":"xxx演出1", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-05T18:00:00",
              "endTime": "2023-01-06T22:00:00",
              "location": "主A4-3",
          },
          {
              "showId":3,
              "title":"xxx演出2", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-02T18:00:00",
              "endTime": "2023-01-02T22:00:00",
              "location": "主A4-3",
          },
          {
              "showId":4,
              "title":"xxx演出2", // 可以有多场内容完全一直的演出,就是时间场地不一致
              "startTime": "2023-01-03T18:00:00",
              "endTime": "2023-01-03T22:00:00",
              "location": "主A4-3",
          }
      ]
    }
  }
  ```

### 获取用户列表`GET /api/admin/users`

- Request

  | query参数 |  类型  | 示例 |
  |-----------|--------|------|
  |   page    | number |  1   |
  |   size    | number |  2   |

- Response

  ```json
  {
    "success": true,
    "data": {
      "total": 10,
      "users":[
          {
              "userId":1,
              "userName":"czcz"
          },
          {
              "userId":2,
              "userName":"xzxz"
          },
      ]
    }
  }
  ```

### 获取用户`GET /api/admin/user/:id`

- Request


- Response

  ```json
  {
    "success": true,
    "data": {
      "userId":1,
      "userName":"czcz"
    }
  }
  ```

### 新增明星 `POST /api/admin/star`

- Request

  ```json
  {
      "name":"明星A",
      "intro":"我是练习时长两年半的个人练习生"
  }
  ```

- Response

  ```json
  {
    "success": true,
    "data": {
  	"starId":1
    }
  }
  ```

### 修改明星信息 `PUT /api/admin/star/:id`

- Request

  ```json
  {

      "name":"明星A",
      "intro":"介绍"
  }
  ```

- Response

  ```json
  {
    "success": true,
    "data": {
  	"starId":1
    }
  }
  ```

### 分页查询明星 `PUT /api/admin/stars`

- Request

|  query参数   |  类型  | 示例  |
|--------------|--------|-------|
|     page     | number |   1   |
|     size     | number |   2   |
| name(非必需) | string | 明星A |

- Response

  ```json
  {
    "success": true,
    "data": {
      "total": 10,
      "users":[
          {
              "starId":1,
              "name":"Hello",
              "intro":"介绍1"
          },
          {
              "starId":2,
              "name":"Kity",
              "intro":"介绍2"
          }
      ]
    }
  }
  ```

### 删除明星 `DELETE /api/admin/star/:id`

- Request

- Response

  ```json
  {
    "success": true,
  }
  ```
